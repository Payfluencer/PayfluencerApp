<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payfluencer Chat Test</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .container {
        margin-top: 40px;
      }
      #chatContainer {
        display: none;
      }
      .chat-window {
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        background-color: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        margin-bottom: 15px;
      }
      .chat-message {
        margin-bottom: 15px;
        padding: 10px 15px;
        border-radius: 18px;
        max-width: 80%;
        position: relative;
      }
      .my-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }
      .other-message {
        background-color: #e9ecef;
        color: #212529;
        margin-right: auto;
        border-bottom-left-radius: 4px;
      }
      .message-info {
        font-size: 0.75rem;
        margin-bottom: 5px;
      }
      .my-message .message-info {
        text-align: right;
        color: #f8f9fa;
      }
      .other-message .message-info {
        color: #6c757d;
      }
      .typing-indicator {
        color: #6c757d;
        font-style: italic;
        margin-bottom: 10px;
        display: none;
      }
      .online-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 5px;
      }
      .online {
        background-color: #28a745;
      }
      .offline {
        background-color: #dc3545;
      }
      .status-bar {
        margin-bottom: 15px;
        font-size: 0.9rem;
      }
      .user-info {
        margin-bottom: 20px;
      }
      .form-group {
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="text-center mb-4">Payfluencer Chat Test</h1>

      <!-- Login Form -->
      <div id="loginContainer" class="card p-4 mb-4">
        <h3 class="mb-3">Login</h3>
        <div class="form-group">
          <label for="email">Email</label>
          <input
            type="email"
            class="form-control"
            id="email"
            placeholder="Enter your email"
          />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input
            type="password"
            class="form-control"
            id="password"
            placeholder="Enter your password"
          />
        </div>
        <button id="loginBtn" class="btn btn-primary">Login</button>
        <div id="loginMessage" class="mt-3 text-danger"></div>
      </div>

      <!-- Chat Container -->
      <div id="chatContainer">
        <div class="user-info card p-3 mb-4">
          <h4>User Info</h4>
          <div><strong>Name:</strong> <span id="userName"></span></div>
          <div><strong>Email:</strong> <span id="userEmail"></span></div>
          <div><strong>Role:</strong> <span id="userRole"></span></div>
        </div>

        <div class="card p-3 mb-4">
          <h3 class="mb-3">Chat Settings</h3>

          <div class="row mb-3">
            <div class="col-md-6">
              <div class="form-group">
                <label for="chatType">Chat Type</label>
                <select class="form-control" id="chatType">
                  <option value="admin">Admin Chat</option>
                  <option value="report">Report Chat</option>
                </select>
              </div>
            </div>
            <div class="col-md-6" id="entityIdContainer">
              <div class="form-group">
                <label for="entityId">Report ID</label>
                <input
                  type="text"
                  class="form-control"
                  id="entityId"
                  placeholder="Enter Report ID"
                />
              </div>
            </div>
          </div>

          <button id="connectBtn" class="btn btn-success">
            Connect to Chat
          </button>
          <button id="disconnectBtn" class="btn btn-outline-danger ms-2">
            Disconnect
          </button>
          <div id="connectionMessage" class="mt-2"></div>
        </div>

        <div class="card p-3">
          <div class="status-bar">
            <span>Status: </span>
            <span class="online-indicator offline" id="statusIndicator"></span>
            <span id="statusText">Disconnected</span>
          </div>

          <div class="chat-window" id="chatWindow">
            <!-- Messages will appear here -->
          </div>

          <div class="typing-indicator" id="typingIndicator">
            Someone is typing...
          </div>

          <div class="input-group">
            <input
              type="text"
              class="form-control"
              id="messageInput"
              placeholder="Type a message..."
              disabled
            />
            <button class="btn btn-primary" id="sendBtn" disabled>Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // DOM Elements
      const loginContainer = document.getElementById("loginContainer");
      const chatContainer = document.getElementById("chatContainer");
      const loginBtn = document.getElementById("loginBtn");
      const loginMessage = document.getElementById("loginMessage");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const userName = document.getElementById("userName");
      const userEmail = document.getElementById("userEmail");
      const userRole = document.getElementById("userRole");
      const chatType = document.getElementById("chatType");
      const entityId = document.getElementById("entityId");
      const entityIdContainer = document.getElementById("entityIdContainer");
      const connectBtn = document.getElementById("connectBtn");
      const disconnectBtn = document.getElementById("disconnectBtn");
      const connectionMessage = document.getElementById("connectionMessage");
      const statusIndicator = document.getElementById("statusIndicator");
      const statusText = document.getElementById("statusText");
      const chatWindow = document.getElementById("chatWindow");
      const typingIndicator = document.getElementById("typingIndicator");
      const messageInput = document.getElementById("messageInput");
      const sendBtn = document.getElementById("sendBtn");

      // State
      let socket = null;
      let currentUser = null;
      let currentChatId = null;
      let typingTimeout = null;

      // Login Function
      loginBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();

        if (!email || !password) {
          loginMessage.textContent = "Please enter both email and password";
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:8001/api/v1/user/admin/login",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include", // Important for cookie-based auth
              body: JSON.stringify({
                email,
                password,
              }),
            }
          );

          const data = await response.json();

          if (data.status === "success") {
            currentUser = data.data.user;

            // Update UI with user info
            userName.textContent = currentUser.name || "N/A";
            userEmail.textContent = currentUser.email || "N/A";
            userRole.textContent = currentUser.role || "N/A";

            // Show chat interface
            loginContainer.style.display = "none";
            chatContainer.style.display = "block";

            // Display success message
            connectionMessage.textContent =
              "Logged in successfully. Connect to a chat.";
            connectionMessage.className = "mt-2 text-success";

            // Set up chat type change handler
            chatType.addEventListener("change", function () {
              if (this.value === "admin") {
                entityIdContainer.style.display = "none";
              } else {
                entityIdContainer.style.display = "block";
              }
            });

            // Trigger change event to set initial state
            chatType.dispatchEvent(new Event("change"));
          } else {
            loginMessage.textContent = data.message || "Login failed";
          }
        } catch (error) {
          console.error("Login error:", error);
          loginMessage.textContent = "Error connecting to server";
        }
      });

      // Connect to Chat
      connectBtn.addEventListener("click", () => {
        if (!currentUser) {
          connectionMessage.textContent = "You must be logged in to connect";
          connectionMessage.className = "mt-2 text-danger";
          return;
        }

        const type = chatType.value;
        const id = entityId.value.trim();

        if (type !== "admin" && !id) {
          connectionMessage.textContent =
            "Please enter an ID for the selected chat type";
          connectionMessage.className = "mt-2 text-danger";
          return;
        }

        // Initialize Socket.IO connection
        socket = io("http://localhost:8001", {
          path: "/chat/ws",
          withCredentials: true, // Important for cookie-based auth
        });

        // Connection events
        socket.on("connect", () => {
          connectionMessage.textContent =
            "Connected to server. Joining chat...";
          connectionMessage.className = "mt-2 text-info";

          // Join chat room
          const joinData = {
            reportId: type === "report" ? id : undefined,
            chatId: undefined, // Used by admin to join specific chats
          };

          socket.emit("chat:join", joinData);
        });

        socket.on("connect_error", (error) => {
          console.error("Connection error:", error);
          connectionMessage.textContent = `Connection error: ${error.message}`;
          connectionMessage.className = "mt-2 text-danger";
          updateStatus(false);
        });

        // Chat events
        socket.on("chat:join", (response) => {
          if (response.status === "success") {
            currentChatId = response.data.chatId;
            connectionMessage.textContent = `Joined chat room successfully. Chat ID: ${currentChatId}`;
            connectionMessage.className = "mt-2 text-success";

            // Enable chat controls
            messageInput.disabled = false;
            sendBtn.disabled = false;

            // Load chat history
            socket.emit("chat:history", { chatId: currentChatId });
          } else {
            connectionMessage.textContent =
              response.message || "Failed to join chat";
            connectionMessage.className = "mt-2 text-danger";
          }
        });

        socket.on("chat:history", (response) => {
          if (response.status === "success") {
            // Clear current messages
            chatWindow.innerHTML = "";

            // Update online status
            updateStatus(response.data.online);

            // Display messages
            const messages = response.data.messages;
            messages.forEach((message) => {
              addMessageToChat(message);
            });

            // Scroll to bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
          }
        });

        socket.on("chat:message", (response) => {
          if (response.status === "success") {
            // Add new message
            addMessageToChat(response.data.message);

            // Update online status
            updateStatus(response.data.online);

            // Scroll to bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // Hide typing indicator
            typingIndicator.style.display = "none";
          }
        });

        socket.on("chat:typing", (response) => {
          if (response.status === "success" && response.data.isTyping) {
            // Show typing indicator
            typingIndicator.style.display = "block";
          } else {
            // Hide typing indicator
            typingIndicator.style.display = "none";
          }
        });

        socket.on("chat:online.status", (response) => {
          if (response.status === "success") {
            updateStatus(response.data.online);
          }
        });

        socket.on("error", (error) => {
          console.error("Socket error:", error);
          connectionMessage.textContent = error.message || "An error occurred";
          connectionMessage.className = "mt-2 text-danger";
        });
      });

      // Disconnect from Chat
      disconnectBtn.addEventListener("click", () => {
        if (socket) {
          if (currentChatId) {
            // Determine roomId based on chat type
            let roomId;
            if (chatType.value === "report") {
              roomId = `report_${entityId.value}`;
            } else {
              roomId = `admin_user_${currentUser.id}`;
            }

            socket.emit("chat:leave", { roomId });
          }
          socket.disconnect();
          socket = null;
          currentChatId = null;

          // Disable chat controls
          messageInput.disabled = true;
          sendBtn.disabled = true;

          // Update UI
          updateStatus(false);
          connectionMessage.textContent = "Disconnected from chat";
          connectionMessage.className = "mt-2 text-warning";
        }
      });

      // Send Message
      sendBtn.addEventListener("click", () => {
        sendMessage();
      });

      messageInput.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
          sendMessage();
        }

        // Send typing indicator
        if (socket && currentChatId) {
          // Clear previous timeout
          if (typingTimeout) {
            clearTimeout(typingTimeout);
          }

          // Send typing = true
          socket.emit("chat:typing", {
            chatId: currentChatId,
            isTyping: true,
          });

          // Set timeout to send typing = false
          typingTimeout = setTimeout(() => {
            socket.emit("chat:typing", {
              chatId: currentChatId,
              isTyping: false,
            });
          }, 2000);
        }
      });

      // Helper Functions
      function sendMessage() {
        const message = messageInput.value.trim();

        if (!message || !socket || !currentChatId) {
          return;
        }

        socket.emit("chat:message", {
          chatId: currentChatId,
          content: message,
        });

        // Clear input
        messageInput.value = "";
      }

      function addMessageToChat(message) {
        const messageElement = document.createElement("div");
        const isMyMessage = message.sender_id === currentUser.id;

        messageElement.className = `chat-message ${
          isMyMessage ? "my-message" : "other-message"
        }`;

        const messageInfo = document.createElement("div");
        messageInfo.className = "message-info";

        // Display appropriate sender info
        let senderName = "Unknown";
        if (message.sender && message.sender.name) {
          senderName = message.sender.name;
        }

        // Add role indicator for admin or company
        if (message.sender && message.sender.role === "ADMIN") {
          senderName += " (Admin)";
        } else if (
          message.sender &&
          message.sender.role === "COMPANY_MANAGER"
        ) {
          senderName += " (Company Manager)";
        } else {
          senderName += " (User)";
        }

        messageInfo.textContent = `${senderName} - ${formatDate(
          message.created_at
        )}`;

        const messageContent = document.createElement("div");
        messageContent.textContent = message.content;

        messageElement.appendChild(messageInfo);
        messageElement.appendChild(messageContent);

        chatWindow.appendChild(messageElement);
      }

      function updateStatus(isOnline) {
        if (isOnline) {
          statusIndicator.className = "online-indicator online";
          statusText.textContent = "Online";
        } else {
          statusIndicator.className = "online-indicator offline";
          statusText.textContent = "Offline";
        }
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit",
        });
      }

      // Helper functions to determine chat type
      function isAdminChat() {
        return chatType.value === "admin";
      }

      function isReportChat() {
        return chatType.value === "report";
      }
    </script>
  </body>
</html>
